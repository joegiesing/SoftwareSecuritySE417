@page
@using Microsoft.AspNetCore.Http
@model ResearchVault.Pages.Admin.ControlPanelModel
@{
    ViewData["Title"] = "Control Panel";
    var currentPermission = HttpContext.Session.GetInt32("Permissions") ?? 0;
    var isPrimaryAdmin = currentPermission >= 2;
}

<style>
    .form-floating:focus-within {
        z-index: 2;
    }

    .preview-border {
        border: var(--bs-border-width) solid var(--bs-border-color);
        border-radius: var(--bs-border-radius);
    }

    .user-table {
        max-height: 500px;
        overflow-y: auto;
    }
</style>

<script>
    window.addEventListener('DOMContentLoaded', function () {
        var formHeight = document.querySelector('#main-form').offsetHeight;
        var userListContainer = document.getElementById('userListContainer');
        if (userListContainer && formHeight) {
            userListContainer.style.maxHeight = formHeight + 'px';
        }
    });
</script>

<div class="container mt-3">

    <h3 class="ms-3 mt-1" style="">Admin</h3>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row form-font-view">

        @* User List Display *@
        <div class="col-md-4 container-fluid d-flex flex-column shadow bg-body-tertiary preview-border ps-3 pe-3 pb-3 pt-2">

            <div class="d-flex">
                <h5 class="ms-3 d-flex" style="">User List</h5>
            </div>

            <div class="container d-flex" style="flex:auto; overflow-y: auto; max-height: 500px" id="userListContainer">
                @if (Model.lstUser == null || !Model.lstUser.Any())
                {
                    <p class="text-center mt-3">No users found.</p>
                }
                else
                {
                    <table class="table table-hover table-sm mb-0">
                        <thead class="sticky-top bg-body-tertiary">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                @if (isPrimaryAdmin)
                                {
                                    <th>Actions</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model.lstUser)
                            {
                                <tr>
                                    <td>@user.FName @user.LName</td>
                                    <td>@user.Email</td>
                                    <td>
                                        @switch (user.Permissions)
                                        {
                                            case 2:
                                                <span class="badge bg-danger">Primary Admin</span>
                                                break;
                                            case 1:
                                                <span class="badge bg-warning text-dark">Secondary Admin</span>
                                                break;
                                            case 0:
                                                <span class="badge bg-info text-dark">Basic User</span>
                                                break;
                                            default:
                                                <span class="badge bg-secondary">Unknown</span>
                                                break;
                                        }
                                    </td>
                                    @if (isPrimaryAdmin)
                                    {
                                        <td>
                                            <form asp-page-handler="Edit" asp-route-id="@user.UserID" method="post" class="d-inline">
                                                <button type="submit" style="border: none; background: none; padding: 0; cursor: pointer;" title="Edit User">
                                                    <img src="~/images/pencil-fill.svg" style="height: 14px; width: 14px;" alt="Edit" />
                                                </button>
                                            </form>

                                            <form method="post" asp-page-handler="Delete" asp-route-id="@user.UserID" class="d-inline ms-2" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                                <button type="submit" style="border: none; background: none; padding: 0; cursor: pointer;" title="Delete User">
                                                    <img src="~/images/trash3-fill.svg" style="height: 14px; width: 14px;" alt="Delete" />
                                                </button>
                                            </form>
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>

        </div>

        @* Edit User Form *@
        <form method="post" class="col-md-8" id="main-form">

            <div class="container">

                @if (!isPrimaryAdmin)
                {
                    <div class="alert alert-info" role="alert">
                        You are viewing as Secondary Admin. Only Primary Admins can edit or delete users.
                    </div>
                }

                <div class="row mb-2">

                    <div class="form-floating col-md-8">

                        <input type="text" asp-for="rUser.FName" runat="server" class="form-control" placeholder="First Name" disabled="@(!isPrimaryAdmin)" />
                        <label asp-for="rUser.FName" class="form-label" style="margin-left: 12px;">First Name</label>
                        <div style="display:block; height:24px;">
                            <span asp-validation-for="rUser.FName" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-floating col-md-4">

                        <select asp-for="rUser.Permissions" class="form-select" placeholder="Permissions" disabled="@(!isPrimaryAdmin)">
                            <option selected value="">Access Level</option>
                            <option value=2>Primary Admin</option>
                            <option value=1>Secondary Admin</option>
                            <option value=0>Basic User</option>
                        </select>

                        <label asp-for="rUser.Permissions" class="form-label" style="margin-left: 12px;">Permissions</label>

                        <div style="display:block; height:24px;">
                            <span asp-validation-for="rUser.Permissions" class="text-danger"></span>
                        </div>
                    </div>

                </div>
                <div class="row mb-2">

                    <div class="form-floating col-md-8">

                        <input type="text" asp-for="rUser.LName" class="form-control" placeholder="Last Name" disabled="@(!isPrimaryAdmin)" />
                        <label asp-for="rUser.LName" class="form-label" style="margin-left: 12px;">Last Name</label>

                        <div style="display:block; height:24px;">
                            <span asp-validation-for="rUser.LName" class="text-danger"></span>
                        </div>
                    </div>

                </div>
                <div class="row mb-2">

                    <div class="form-floating col-md-8">

                        <input type="text" asp-for="rUser.Username" class="form-control" placeholder="Username" disabled="@(!isPrimaryAdmin)" />
                        <label asp-for="rUser.Username" class="form-label" style="margin-left: 12px;">Username</label>

                        <div style="display:block; height:24px;">
                            <span asp-validation-for="rUser.Username" class="text-danger"></span>
                        </div>
                    </div>


                </div>
                <div class="row mb-2">

                    <div class="form-floating col-md-8">

                        <input type="email" asp-for="rUser.Email" class="form-control" placeholder="Email" disabled="@(!isPrimaryAdmin)" />
                        <label asp-for="rUser.Email" class="form-label" style="margin-left: 12px;">Email</label>

                        <div style="display:block; height:24px;">
                            <span asp-validation-for="rUser.Email" class="text-danger"></span>
                        </div>
                    </div>


                </div>
                <div class="row mb-2">

                    <div class="form-floating col-md-8">

                        <input type="text" asp-for="rUser.Password" class="form-control" placeholder="Password" disabled="@(!isPrimaryAdmin)" />
                        <label asp-for="rUser.Password" class="form-label" style="margin-left: 12px;">Password</label>

                        <div style="display:block; height:24px;">
                            <span asp-validation-for="rUser.Password" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="row justify-content-center">
                    @if (isPrimaryAdmin && Model.rUser != null)
                    {
                        <button class="btn btn-primary btn-rv2 me-2" style="width: 100px;" type="submit" asp-page-handler="Update" asp-route-id="@Model.rUser.UserID">Update</button>
                        <button class="btn btn-danger ms-2" style="width: 100px;" type="submit" asp-page-handler="Delete" asp-route-id="@Model.rUser.UserID">Delete</button>
                    }
                </div>

                <input asp-for="rUser.UserID" type="hidden" class="form-control" />

            </div>

        </form>
    </div>
</div>

@if (Model.rUser != null && Model.rUser.Feedback != null)
{
    <h1>Results</h1>
    <p>@Model.rUser.Feedback</p>
}